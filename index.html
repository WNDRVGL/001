<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Event Message (SNS style)</title>

  <!-- LINE Seed JP -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=LINE+Seed+JP:wght@400;700;800&display=swap" rel="stylesheet">

  <style>
    html, body{
      margin:0;
      height:100%;
      background:#000;
      overflow:hidden;
      font-family:"LINE Seed JP", system-ui, -apple-system, "Hiragino Kaku Gothic ProN","Noto Sans JP","Meiryo", sans-serif;
    }

    .stage{
      position:fixed;
      inset:0;
      background:#000;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 24px;
      box-sizing:border-box;
    }

    /* 吹き出し */
    .bubble{
      position:relative;
      width:min(920px, 92vw);
      max-width: 92vw;
      padding: clamp(18px, 3.2vh, 36px) clamp(18px, 3.2vh, 44px);
      border-radius: 26px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.16);
      box-shadow:
        0 24px 70px rgba(0,0,0,.65),
        inset 0 1px 0 rgba(255,255,255,.10);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }

    /* しっぽ */
    .bubble:after{
      content:"";
      position:absolute;
      left: 46px;
      bottom: -18px;
      width: 0; height: 0;
      border-left: 18px solid transparent;
      border-right: 18px solid transparent;
      border-top: 18px solid rgba(255,255,255,.10);
      filter: drop-shadow(0 4px 0 rgba(255,255,255,.06));
    }

    .text{
      font-weight: 800;
      font-size: clamp(30px, 6.2vh, 86px);
      line-height: 1.12;
      letter-spacing: .02em;
      text-align:left;
      color: #ffffff;
      text-shadow: 0 3px 22px rgba(0,0,0,.65);
      word-break: break-word;
      white-space: pre-wrap;
    }

    .meta{
      margin-top: 12px;
      font-size: 14px;
      color: rgba(255,255,255,.55);
      font-weight: 700;
      letter-spacing: .2px;
      display:flex;
      gap:10px;
      align-items:center;
      user-select:none;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.70);
      font-size: 12px;
      font-weight: 800;
    }

    /* 出現/退場アニメ（SNSっぽく） */
    .enter{
      opacity:0;
      transform: translateY(14px) scale(1.03);
      animation: enter .22s ease-out forwards;
    }
    @keyframes enter{
      to{ opacity:1; transform: translateY(0) scale(1); }
    }

    .leave{
      animation: leave .28s ease-in forwards;
    }
    @keyframes leave{
      to{ opacity:0; transform: translateY(-10px) scale(.98); }
    }

    /* 一瞬フラッシュ（新着強調） */
    .flash{
      animation: flash .35s ease-out 1;
    }
    @keyframes flash{
      0%{ filter: brightness(1); }
      20%{ filter: brightness(1.9); }
      100%{ filter: brightness(1); }
    }

    .status{
      position: fixed;
      left: 12px;
      bottom: 10px;
      font-size: 12px;
      color: rgba(255,255,255,0.45);
      user-select:none;
      font-weight: 700;
      letter-spacing: .2px;
      pointer-events:none;
    }
  </style>
</head>

<body>
  <div class="stage">
    <div id="bubble" class="bubble">
      <div id="text" class="text">#connecting…</div>
      <div class="meta">
        <span class="pill">LIVE</span>
        <span id="meta">waiting</span>
      </div>
    </div>
  </div>

  <div id="status" class="status">connecting…</div>

  <script>
    // Apps Script WebアプリURL(/exec)
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzLnD6M9UcMuxu-u4AzM_aOY_8yBR90NNPSYQp4rAVczef8jWkYiFrkxv3N2UQMivI2/exec";

    // C列固定（GASがC列だけ返す想定でも、HTMLから送っておく）
    const TARGET_COL = "C";

    // 10秒ごとに取得
    const POLL_MS = 10000;

    // 1件の表示時間（約10秒）
    const SHOW_MS = 10000;

    // 20字でカット
    const MAX_CHARS = 20;

    const statusEl = document.getElementById("status");
    const bubbleEl = document.getElementById("bubble");
    const textEl = document.getElementById("text");
    const metaEl = document.getElementById("meta");

    let lastRowSeen = 1;
    const seenKeys = new Set();

    // 表示待ちキュー
    const queue = [];
    let isShowing = false;

    function setStatus(t){ statusEl.textContent = t; }

    function fetchJSONP(url, params = {}) {
      return new Promise((resolve, reject) => {
        const cbName = "cb_" + Math.random().toString(36).slice(2);
        const script = document.createElement("script");
        const q = new URLSearchParams({ ...params, callback: cbName, t: String(Date.now()) });

        const cleanup = () => { try { delete window[cbName]; } catch {} script.remove(); };

        window[cbName] = (data) => { cleanup(); resolve(data); };
        script.onerror = () => { cleanup(); reject(new Error("JSONP load error")); };

        script.src = url + (url.includes("?") ? "&" : "?") + q.toString();
        document.body.appendChild(script);

        setTimeout(() => {
          if (window[cbName]) { cleanup(); reject(new Error("JSONP timeout")); }
        }, 8000);
      });
    }

    function trimToMaxChars(s){
      const str = String(s ?? "");
      // サロゲートペアも考慮して安全に切る（絵文字など）
      const arr = Array.from(str);
      return arr.slice(0, MAX_CHARS).join("");
    }

    function enqueueMessage(text, rowId){
      const clean = String(text || "").trim();
      if(!clean) return;

      const key = (rowId != null) ? `row:${rowId}` : `txt:${clean}`;
      if(seenKeys.has(key)) return;
      seenKeys.add(key);

      queue.push({
        text: "#" + trimToMaxChars(clean),
        row: rowId
      });
    }

    async function poll(){
      try{
        const data = await fetchJSONP(SCRIPT_URL, {
          since: String(lastRowSeen),
          col: TARGET_COL
        });

        if(data && data.ok){
          const msgs = Array.isArray(data.messages) ? data.messages : [];
          msgs.forEach(m => {
            if(m && m.text) enqueueMessage(m.text, m.row);
          });

          const lr = Number(data.lastRow || lastRowSeen);
          if(Number.isFinite(lr)) lastRowSeen = Math.max(lastRowSeen, lr);

          setStatus(`ok | queue=${queue.length} | lastRow=${lastRowSeen}`);
          kick();
        } else {
          setStatus("response not ok");
        }
      } catch (e){
        setStatus("error: " + e.message);
      }
    }

    function showOne(msg){
      isShowing = true;

      // テキスト反映
      textEl.textContent = msg.text;

      const now = new Date();
      metaEl.textContent = `${now.toLocaleTimeString()}  /  #${msg.row ?? "?"}`;

      // アニメ
      bubbleEl.classList.remove("leave");
      bubbleEl.classList.add("enter", "flash");
      setTimeout(() => bubbleEl.classList.remove("enter"), 260);
      setTimeout(() => bubbleEl.classList.remove("flash"), 420);

      // 10秒後に退場 → 次へ
      setTimeout(() => {
        bubbleEl.classList.add("leave");
        setTimeout(() => {
          bubbleEl.classList.remove("leave");
          isShowing = false;
          kick();
        }, 300);
      }, SHOW_MS);
    }

    function kick(){
      if(isShowing) return;
      if(queue.length === 0) return;
      const msg = queue.shift();
      showOne(msg);
    }

    function init(){
      poll();
      setInterval(poll, POLL_MS);
    }

    init();
  </script>
</body>
</html>
